rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAttemptOwner(attemptId) {
      return isSignedIn() &&
        get(/databases/$(database)/documents/userAttempts/$(attemptId)).data.userId == request.auth.uid;
    }

    function isNumeric(value) {
      return value is int || value is float;
    }

    function hasQuestionCoreFields(data) {
      return data.keys().hasAll([
        'type',
        'question_text',
        'metadata',
        'difficulty',
        'topic',
        'skillCategory',
        'createdAt',
        'lastModified',
        'isArchived'
      ]);
    }

    function isQuestionCoreValid(data) {
      return hasQuestionCoreFields(data) &&
        data.type in ['mcq', 'short_answer', 'numeric', 'long_answer'] &&
        data.question_text is string &&
        data.question_text.size() > 0 &&
        data.metadata is map &&
        data.difficulty in [1, 2, 3] &&
        data.topic is string &&
        data.topic.size() > 0 &&
        data.skillCategory in [1, 2, 3] &&
        data.isArchived is bool &&
        data.createdAt is timestamp &&
        data.lastModified is timestamp &&
        (!('explanation' in data) || data.explanation is string);
    }

    function isQuestionMetadataValid(data) {
      let metadata = data.metadata;
      return (
        data.type == 'mcq' &&
        metadata.keys().hasAll(['options', 'correct_answer']) &&
        metadata.options is list &&
        metadata.options.size() >= 2 &&
        metadata.correct_answer is string
      ) || (
        data.type == 'short_answer' &&
        metadata.keys().hasAll(['accepted_answers', 'case_sensitive', 'ignore_whitespace']) &&
        metadata.accepted_answers is list &&
        metadata.accepted_answers.size() > 0 &&
        metadata.case_sensitive is bool &&
        metadata.ignore_whitespace is bool
      ) || (
        data.type == 'numeric' &&
        metadata.keys().hasAll(['numeric_answer']) &&
        isNumeric(metadata.numeric_answer) &&
        (!('tolerance' in metadata) || (isNumeric(metadata.tolerance) && metadata.tolerance >= 0))
      ) || (
        data.type == 'long_answer'
      );
    }

    function isQuestionDocumentValid(data) {
      return isQuestionCoreValid(data) && isQuestionMetadataValid(data);
    }

    function hasQuizCoreFields(data) {
      return data.keys().hasAll([
        'title',
        'description',
        'topic',
        'difficulty',
        'estimatedTime',
        'isTimePerQuestion',
        'questionIds',
        'questionCount',
        'createdAt',
        'lastModified',
        'isArchived'
      ]);
    }

    function isQuizDocumentValid(data) {
      return hasQuizCoreFields(data) &&
        data.title is string &&
        data.title.size() > 0 &&
        data.description is string &&
        data.description.size() > 0 &&
        data.topic is string &&
        data.topic.size() > 0 &&
        data.difficulty in [1, 2, 3] &&
        isNumeric(data.estimatedTime) &&
        data.estimatedTime > 0 &&
        data.isTimePerQuestion is bool &&
        data.questionIds is list &&
        data.questionCount is int &&
        data.questionCount >= 0 &&
        data.questionCount <= data.questionIds.size() &&
        data.createdAt is timestamp &&
        data.lastModified is timestamp &&
        data.isArchived is bool;
    }

    function hasCourseCoreFields(data) {
      return data.keys().hasAll([
        'title',
        'description',
        'topic',
        'quizIds',
        'quizCount',
        'createdAt',
        'lastModified',
        'isArchived'
      ]);
    }

    function isCourseDocumentValid(data) {
      return hasCourseCoreFields(data) &&
        data.title is string &&
        data.title.size() > 0 &&
        data.description is string &&
        data.description.size() > 0 &&
        (!('courseCode' in data) || (data.courseCode is string && data.courseCode.size() > 0)) &&
        data.topic is string &&
        data.topic.size() > 0 &&
        data.quizIds is list &&
        data.quizCount is int &&
        data.quizCount >= 0 &&
        data.quizCount <= data.quizIds.size() &&
        data.createdAt is timestamp &&
        data.lastModified is timestamp &&
        data.isArchived is bool;
    }

    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /questions/{questionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isQuestionDocumentValid(request.resource.data);
      allow update: if isSignedIn() &&
        isQuestionDocumentValid(request.resource.data) &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn();
    }

    match /quizzes/{quizId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isQuizDocumentValid(request.resource.data);
      allow update: if isSignedIn() &&
        isQuizDocumentValid(request.resource.data) &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn();
    }

    match /courses/{courseId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isCourseDocumentValid(request.resource.data);
      allow update: if isSignedIn() &&
        isCourseDocumentValid(request.resource.data) &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn();
    }

    match /userAttempts/{attemptId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      match /answers/{answerId} {
        allow read: if isAttemptOwner(attemptId);
        allow create: if isAttemptOwner(attemptId) && request.resource.data.userId == request.auth.uid;
        allow update: if isAttemptOwner(attemptId) && resource.data.userId == request.auth.uid;
      }
    }
  }
}
